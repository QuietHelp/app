version: '3.8'

services:
  redis:
    image: redis:latest
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - quiethelp
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      POSTGRES_URL: jdbc:postgresql://quiethelp-infra-db-1:5432/quiethelp
      POSTGRES_USER: tarbi
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: "6379"
    depends_on:
      - redis
    networks:
      - quiethelp
      - web
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M

  # Python Chatbot Microservice
  chatbot:
    build:
      context: ../chatbot-service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
      AI_MODEL: gemini-2.0-flash
    depends_on:
      - redis
    networks:
      - quiethelp
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  # Lightweight API Gateway
  api-gateway:
    build:
      context: ../api-gateway
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      BACKEND_URL: http://backend:8080
      CHATBOT_URL: http://chatbot:8000
      REDIS_HOST: redis
      REDIS_PORT: "6379"
    depends_on:
      - backend
      - chatbot
      - redis
    networks:
      - quiethelp
      - web
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: https://api.quiet-help.life
        NEXT_PUBLIC_WS_URL: wss://api.quiet-help.life
    restart: unless-stopped
    depends_on:
      - api-gateway
    networks:
      - quiethelp
      - web
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

volumes:
  redis-data:
    name: quiethelp-redis-data

networks:
  quiethelp:
    external: true
  web:
    external: true