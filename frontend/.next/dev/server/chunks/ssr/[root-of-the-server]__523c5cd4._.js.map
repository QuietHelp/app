{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/tarbipyakurel/Desktop/QuietHelp-app/frontend/components/ChatBroadcast.tsx"],"sourcesContent":["'use client';\n\nimport { useEffect, useState, useRef, useCallback } from 'react';\nimport type { IMessage, StompSubscription } from '@stomp/stompjs';\nimport { Client } from '@stomp/stompjs';\nimport SockJS from 'sockjs-client';\nimport { GlobeIcon } from 'lucide-react';\n\ninterface ChatMessage {\n  username: string;\n  message: string;\n  timestamp: number;\n}\n\nconst WS_URL = process.env.NEXT_PUBLIC_WS_URL || 'http://localhost:8080/ws';\n\nexport default function ChatBroadcast() {\n  const [messages, setMessages] = useState<ChatMessage[]>([]);\n  const [input, setInput] = useState('');\n  const [isConnected, setIsConnected] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const clientRef = useRef<Client | null>(null);\n  const subscriptionRef = useRef<StompSubscription | null>(null);\n  const reconnectTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const usernameRef = useRef<string>('');\n\n  // Generate username once on mount\n  useEffect(() => {\n    // Generate or retrieve username from localStorage\n    let username = localStorage.getItem('chat_username');\n    if (!username) {\n      const randomNum = Math.floor(Math.random() * 10000);\n      username = `Guest-${randomNum.toString().padStart(4, '0')}`;\n      localStorage.setItem('chat_username', username);\n    }\n    usernameRef.current = username;\n  }, []);\n\n  // Scroll to bottom when new messages arrive\n  useEffect(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\n  }, [messages]);\n\n  // Load chat history on mount\n  const loadChatHistory = useCallback(async () => {\n    try {\n      const backendUrl = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8080';\n      const response = await fetch(`${backendUrl}/api/chat/history`);\n      \n      if (!response.ok) {\n        throw new Error('Failed to load chat history');\n      }\n      \n      const data = await response.json();\n      if (data.messages && Array.isArray(data.messages)) {\n        setMessages(data.messages);\n      }\n    } catch (err) {\n      console.error('Error loading chat history:', err);\n      // Don't show error to user - just continue without history\n    }\n  }, []);\n\n  // Connect to WebSocket\n  const connect = useCallback(() => {\n    try {\n      // Clean up existing connection\n      if (clientRef.current) {\n        clientRef.current.deactivate();\n      }\n\n      const client = new Client({\n        webSocketFactory: () => new SockJS(WS_URL) as unknown as WebSocket,\n        reconnectDelay: 5000,\n        heartbeatIncoming: 4000,\n        heartbeatOutgoing: 4000,\n        onConnect: () => {\n          console.log('WebSocket connected');\n          setIsConnected(true);\n          setError(null);\n\n          // Subscribe to chat messages\n          subscriptionRef.current = client.subscribe(\n            '/topic/chat',\n            (message: IMessage) => {\n              try {\n                const data = JSON.parse(message.body) as ChatMessage;\n                \n                // Validate message structure\n                if (data && typeof data.username === 'string' && typeof data.message === 'string') {\n                  setMessages((prev) => [...prev, data]);\n                } else {\n                  console.warn('Received malformed message:', data);\n                }\n              } catch (err) {\n                console.error('Error parsing message:', err);\n                // Silently ignore malformed messages\n              }\n            }\n          );\n        },\n        onDisconnect: () => {\n          console.log('WebSocket disconnected');\n          setIsConnected(false);\n          subscriptionRef.current = null;\n        },\n        onStompError: (frame) => {\n          console.error('STOMP error:', frame.headers['message'], frame.body);\n          setError('Connection error. Reconnecting...');\n        },\n        onWebSocketError: (event) => {\n          console.error('WebSocket error:', event);\n          setError('Connection error. Reconnecting...');\n        },\n      });\n\n      clientRef.current = client;\n      client.activate();\n    } catch (err) {\n      console.error('Error connecting to WebSocket:', err);\n      setError('Failed to connect. Retrying...');\n      \n      // Retry connection after 5 seconds\n      reconnectTimeoutRef.current = setTimeout(() => {\n        connect();\n      }, 5000);\n    }\n  }, []);\n\n  // Initialize connection and load history\n  useEffect(() => {\n    loadChatHistory();\n    connect();\n\n    return () => {\n      // Cleanup on unmount\n      if (reconnectTimeoutRef.current) {\n        clearTimeout(reconnectTimeoutRef.current);\n      }\n      if (subscriptionRef.current) {\n        subscriptionRef.current.unsubscribe();\n      }\n      if (clientRef.current) {\n        clientRef.current.deactivate();\n      }\n    };\n  }, [connect, loadChatHistory]);\n\n  // Handle manual reconnection\n  const handleReconnect = useCallback(() => {\n    if (clientRef.current && clientRef.current.connected) {\n      return; // Already connected\n    }\n    connect();\n  }, [connect]);\n\n  // Send message\n  const sendMessage = useCallback(async () => {\n    const messageText = input.trim();\n    if (!messageText || !clientRef.current || !clientRef.current.connected) {\n      return;\n    }\n\n    try {\n      // Moderate message before sending\n      const moderationResponse = await fetch('/api/moderate', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ message: messageText }),\n      });\n\n      const moderationResult = await moderationResponse.json();\n\n      if (!moderationResult.isAppropriate) {\n        setError(`Message cannot be sent: ${moderationResult.reason || 'Content violates community guidelines'}`);\n        setTimeout(() => setError(null), 5000);\n        return;\n      }\n\n      clientRef.current.publish({\n        destination: '/app/chat.send',\n        body: JSON.stringify({\n          message: messageText,\n          username: usernameRef.current,\n        }),\n      });\n\n      setInput('');\n      setError(null);\n    } catch (err) {\n      console.error('Error sending message:', err);\n      setError('Failed to send message. Please try again.');\n    }\n  }, [input]);\n\n  // Handle Enter key\n  const handleKeyPress = useCallback(\n    (e: React.KeyboardEvent<HTMLInputElement>) => {\n      if (e.key === 'Enter' && !e.shiftKey) {\n        e.preventDefault();\n        sendMessage();\n      }\n    },\n    [sendMessage]\n  );\n\n  // Format timestamp\n  const formatTimestamp = useCallback((timestamp: number) => {\n    const date = new Date(timestamp);\n    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\n  }, []);\n\n  return (\n    <div className=\"min-h-screen gradient-bg flex flex-col\">\n      <div className=\"container mx-auto max-w-4xl flex-1 flex flex-col p-4 sm:p-6 lg:p-8\">\n        {/* Header */}\n        <div className=\"bg-white/10 backdrop-blur-md border border-white/20 rounded-lg p-4 mb-4\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <h1 className=\"text-2xl font-bold text-white mb-1\"> Global Chat <GlobeIcon className=\"ml-2 h-5 w-5\" /></h1>\n              <p className=\"text-sm text-white/80\">\n                Connected as: <span className=\"font-semibold\">{usernameRef.current}</span>\n              </p>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div\n                className={`w-3 h-3 rounded-full ${isConnected ? 'bg-green-400' : 'bg-red-400'}`}\n                title={isConnected ? 'Connected' : 'Disconnected'}\n              />\n              {!isConnected && (\n                <button\n                  onClick={handleReconnect}\n                  className=\"px-3 py-1 text-sm bg-white/20 hover:bg-white/30 text-white rounded transition-colors\"\n                >\n                  Reconnect\n                </button>\n              )}\n            </div>\n          </div>\n          {error && (\n            <div className=\"mt-2 text-sm text-red-300 bg-red-500/20 p-2 rounded\">\n              {error}\n            </div>\n          )}\n        </div>\n\n        {/* Messages */}\n        <div className=\"flex-1 bg-white/10 backdrop-blur-md border border-white/20 rounded-lg p-4 mb-4 overflow-y-auto min-h-0\">\n          {messages.length === 0 ? (\n            <div className=\"text-center text-white/60 mt-8\">\n              <p>No messages yet. Start the conversation!</p>\n            </div>\n          ) : (\n            <div className=\"space-y-4\">\n              {messages.map((msg, idx) => (\n                <div key={idx} className=\"flex flex-col\">\n                  <div className=\"flex items-baseline gap-2 mb-1\">\n                    <span className=\"font-semibold text-white\">{msg.username}</span>\n                    <span className=\"text-xs text-white/60\">\n                      {formatTimestamp(msg.timestamp)}\n                    </span>\n                  </div>\n                  <div className=\"text-white wrap-break-word bg-white/5 rounded p-2\">\n                    {msg.message}\n                  </div>\n                </div>\n              ))}\n              <div ref={messagesEndRef} />\n            </div>\n          )}\n        </div>\n\n        {/* Input */}\n        <div className=\"flex gap-3\">\n          <input\n            type=\"text\"\n            value={input}\n            onChange={(e) => setInput(e.target.value)}\n            onKeyPress={handleKeyPress}\n            placeholder=\"Type a message...\"\n            disabled={!isConnected}\n            className=\"flex-1 p-3 sm:p-4 text-base bg-white/10 backdrop-blur-md border border-white/20 rounded-lg text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 focus:bg-white/20 disabled:opacity-50 disabled:cursor-not-allowed\"\n          />\n          <button\n            onClick={sendMessage}\n            disabled={!isConnected || !input.trim()}\n            className=\"px-6 sm:px-8 py-3 sm:py-4 bg-white text-blue-600 rounded-lg font-medium hover:bg-white/90 transition-colors focus:outline-none focus:ring-2 focus:ring-white/50 disabled:opacity-50 disabled:cursor-not-allowed\"\n          >\n            Send\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 515, "column": 0}, "map": {"version":3,"sources":["file:///Users/tarbipyakurel/Desktop/QuietHelp-app/frontend/app/chat-broadcast/page.tsx"],"sourcesContent":["'use client';\n\nimport ChatBroadcast from '@/components/ChatBroadcast';\n\nexport default function ChatBroadcastPage() {\n  return <ChatBroadcast />;\n}\n\n"],"names":[],"mappings":";;;;;AAEA;AAFA;;;AAIe,SAAS;IACtB,qBAAO,8OAAC,uIAAa;;;;;AACvB"}}]
}