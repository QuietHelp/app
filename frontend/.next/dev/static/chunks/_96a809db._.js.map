{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/tarbipyakurel/Desktop/QuietHelp-app/frontend/components/ChatBroadcast.tsx"],"sourcesContent":["'use client';\n\nimport { useEffect, useState, useRef, useCallback } from 'react';\nimport type { IMessage, StompSubscription } from '@stomp/stompjs';\nimport { Client } from '@stomp/stompjs';\nimport SockJS from 'sockjs-client';\nimport { GlobeIcon } from 'lucide-react';\n\ninterface ChatMessage {\n  username: string;\n  message: string;\n  timestamp: number;\n}\n\nconst WS_URL = process.env.NEXT_PUBLIC_WS_URL || 'http://localhost:8080/ws';\n\nexport default function ChatBroadcast() {\n  const [messages, setMessages] = useState<ChatMessage[]>([]);\n  const [input, setInput] = useState('');\n  const [isConnected, setIsConnected] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const clientRef = useRef<Client | null>(null);\n  const subscriptionRef = useRef<StompSubscription | null>(null);\n  const reconnectTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const usernameRef = useRef<string>('');\n\n  // Generate username once on mount\n  useEffect(() => {\n    // Generate or retrieve username from localStorage\n    let username = localStorage.getItem('chat_username');\n    if (!username) {\n      const randomNum = Math.floor(Math.random() * 10000);\n      username = `Guest-${randomNum.toString().padStart(4, '0')}`;\n      localStorage.setItem('chat_username', username);\n    }\n    usernameRef.current = username;\n  }, []);\n\n  // Scroll to bottom when new messages arrive\n  useEffect(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\n  }, [messages]);\n\n  // Load chat history on mount\n  const loadChatHistory = useCallback(async () => {\n    try {\n      const backendUrl = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8080';\n      const response = await fetch(`${backendUrl}/api/chat/history`);\n      \n      if (!response.ok) {\n        throw new Error('Failed to load chat history');\n      }\n      \n      const data = await response.json();\n      if (data.messages && Array.isArray(data.messages)) {\n        setMessages(data.messages);\n      }\n    } catch (err) {\n      console.error('Error loading chat history:', err);\n      // Don't show error to user - just continue without history\n    }\n  }, []);\n\n  // Connect to WebSocket\n  const connect = useCallback(() => {\n    try {\n      // Clean up existing connection\n      if (clientRef.current) {\n        clientRef.current.deactivate();\n      }\n\n      const client = new Client({\n        webSocketFactory: () => new SockJS(WS_URL) as unknown as WebSocket,\n        reconnectDelay: 5000,\n        heartbeatIncoming: 4000,\n        heartbeatOutgoing: 4000,\n        onConnect: () => {\n          console.log('WebSocket connected');\n          setIsConnected(true);\n          setError(null);\n\n          // Subscribe to chat messages\n          subscriptionRef.current = client.subscribe(\n            '/topic/chat',\n            (message: IMessage) => {\n              try {\n                const data = JSON.parse(message.body) as ChatMessage;\n                \n                // Validate message structure\n                if (data && typeof data.username === 'string' && typeof data.message === 'string') {\n                  setMessages((prev) => [...prev, data]);\n                } else {\n                  console.warn('Received malformed message:', data);\n                }\n              } catch (err) {\n                console.error('Error parsing message:', err);\n                // Silently ignore malformed messages\n              }\n            }\n          );\n        },\n        onDisconnect: () => {\n          console.log('WebSocket disconnected');\n          setIsConnected(false);\n          subscriptionRef.current = null;\n        },\n        onStompError: (frame) => {\n          console.error('STOMP error:', frame.headers['message'], frame.body);\n          setError('Connection error. Reconnecting...');\n        },\n        onWebSocketError: (event) => {\n          console.error('WebSocket error:', event);\n          setError('Connection error. Reconnecting...');\n        },\n      });\n\n      clientRef.current = client;\n      client.activate();\n    } catch (err) {\n      console.error('Error connecting to WebSocket:', err);\n      setError('Failed to connect. Retrying...');\n      \n      // Retry connection after 5 seconds\n      reconnectTimeoutRef.current = setTimeout(() => {\n        connect();\n      }, 5000);\n    }\n  }, []);\n\n  // Initialize connection and load history\n  useEffect(() => {\n    loadChatHistory();\n    connect();\n\n    return () => {\n      // Cleanup on unmount\n      if (reconnectTimeoutRef.current) {\n        clearTimeout(reconnectTimeoutRef.current);\n      }\n      if (subscriptionRef.current) {\n        subscriptionRef.current.unsubscribe();\n      }\n      if (clientRef.current) {\n        clientRef.current.deactivate();\n      }\n    };\n  }, [connect, loadChatHistory]);\n\n  // Handle manual reconnection\n  const handleReconnect = useCallback(() => {\n    if (clientRef.current && clientRef.current.connected) {\n      return; // Already connected\n    }\n    connect();\n  }, [connect]);\n\n  // Send message\n  const sendMessage = useCallback(async () => {\n    const messageText = input.trim();\n    if (!messageText || !clientRef.current || !clientRef.current.connected) {\n      return;\n    }\n\n    try {\n      // Moderate message before sending\n      const moderationResponse = await fetch('/api/moderate', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ message: messageText }),\n      });\n\n      const moderationResult = await moderationResponse.json();\n\n      if (!moderationResult.isAppropriate) {\n        setError(`Message cannot be sent: ${moderationResult.reason || 'Content violates community guidelines'}`);\n        setTimeout(() => setError(null), 5000);\n        return;\n      }\n\n      clientRef.current.publish({\n        destination: '/app/chat.send',\n        body: JSON.stringify({\n          message: messageText,\n          username: usernameRef.current,\n        }),\n      });\n\n      setInput('');\n      setError(null);\n    } catch (err) {\n      console.error('Error sending message:', err);\n      setError('Failed to send message. Please try again.');\n    }\n  }, [input]);\n\n  // Handle Enter key\n  const handleKeyPress = useCallback(\n    (e: React.KeyboardEvent<HTMLInputElement>) => {\n      if (e.key === 'Enter' && !e.shiftKey) {\n        e.preventDefault();\n        sendMessage();\n      }\n    },\n    [sendMessage]\n  );\n\n  // Format timestamp\n  const formatTimestamp = useCallback((timestamp: number) => {\n    const date = new Date(timestamp);\n    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\n  }, []);\n\n  return (\n    <div className=\"min-h-screen gradient-bg flex flex-col\">\n      <div className=\"container mx-auto max-w-4xl flex-1 flex flex-col p-4 sm:p-6 lg:p-8\">\n        {/* Header */}\n        <div className=\"bg-white/10 backdrop-blur-md border border-white/20 rounded-lg p-4 mb-4\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <h1 className=\"text-2xl font-bold text-white mb-1\"> Global Chat <GlobeIcon className=\"ml-2 h-5 w-5\" /></h1>\n              <p className=\"text-sm text-white/80\">\n                Connected as: <span className=\"font-semibold\">{usernameRef.current}</span>\n              </p>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div\n                className={`w-3 h-3 rounded-full ${isConnected ? 'bg-green-400' : 'bg-red-400'}`}\n                title={isConnected ? 'Connected' : 'Disconnected'}\n              />\n              {!isConnected && (\n                <button\n                  onClick={handleReconnect}\n                  className=\"px-3 py-1 text-sm bg-white/20 hover:bg-white/30 text-white rounded transition-colors\"\n                >\n                  Reconnect\n                </button>\n              )}\n            </div>\n          </div>\n          {error && (\n            <div className=\"mt-2 text-sm text-red-300 bg-red-500/20 p-2 rounded\">\n              {error}\n            </div>\n          )}\n        </div>\n\n        {/* Messages */}\n        <div className=\"flex-1 bg-white/10 backdrop-blur-md border border-white/20 rounded-lg p-4 mb-4 overflow-y-auto min-h-0\">\n          {messages.length === 0 ? (\n            <div className=\"text-center text-white/60 mt-8\">\n              <p>No messages yet. Start the conversation!</p>\n            </div>\n          ) : (\n            <div className=\"space-y-4\">\n              {messages.map((msg, idx) => (\n                <div key={idx} className=\"flex flex-col\">\n                  <div className=\"flex items-baseline gap-2 mb-1\">\n                    <span className=\"font-semibold text-white\">{msg.username}</span>\n                    <span className=\"text-xs text-white/60\">\n                      {formatTimestamp(msg.timestamp)}\n                    </span>\n                  </div>\n                  <div className=\"text-white wrap-break-word bg-white/5 rounded p-2\">\n                    {msg.message}\n                  </div>\n                </div>\n              ))}\n              <div ref={messagesEndRef} />\n            </div>\n          )}\n        </div>\n\n        {/* Input */}\n        <div className=\"flex gap-3\">\n          <input\n            type=\"text\"\n            value={input}\n            onChange={(e) => setInput(e.target.value)}\n            onKeyPress={handleKeyPress}\n            placeholder=\"Type a message...\"\n            disabled={!isConnected}\n            className=\"flex-1 p-3 sm:p-4 text-base bg-white/10 backdrop-blur-md border border-white/20 rounded-lg text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 focus:bg-white/20 disabled:opacity-50 disabled:cursor-not-allowed\"\n          />\n          <button\n            onClick={sendMessage}\n            disabled={!isConnected || !input.trim()}\n            className=\"px-6 sm:px-8 py-3 sm:py-4 bg-white text-blue-600 rounded-lg font-medium hover:bg-white/90 transition-colors focus:outline-none focus:ring-2 focus:ring-white/50 disabled:opacity-50 disabled:cursor-not-allowed\"\n          >\n            Send\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 485, "column": 0}, "map": {"version":3,"sources":["file:///Users/tarbipyakurel/Desktop/QuietHelp-app/frontend/app/chat-broadcast/page.tsx"],"sourcesContent":["'use client';\n\nimport ChatBroadcast from '@/components/ChatBroadcast';\n\nexport default function ChatBroadcastPage() {\n  return <ChatBroadcast />;\n}\n\n"],"names":[],"mappings":";;;;;AAEA;AAFA;;;AAIe,SAAS;IACtB,qBAAO,6LAAC,0IAAa;;;;;AACvB;KAFwB"}}]
}